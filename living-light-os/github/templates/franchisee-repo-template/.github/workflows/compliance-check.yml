name: Compliance Check

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run formation document check
        id: formation
        run: |
          MISSING=""
          REQUIRED_DOCS=(
            "formation/articles-of-incorporation.md"
            "formation/church-bylaws.md"
            "formation/statement-of-faith.md"
            "formation/organizational-meeting-minutes.md"
            "formation/ein-application.md"
          )
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              MISSING="$MISSING\n- $doc"
            fi
          done
          if [ -n "$MISSING" ]; then
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "missing=$MISSING" >> $GITHUB_OUTPUT
          else
            echo "status=PASS" >> $GITHUB_OUTPUT
          fi

      - name: Check governance records
        id: governance
        run: |
          CURRENT_YEAR=$(date +%Y)
          CURRENT_QUARTER=$((( $(date +%-m) - 1) / 3 + 1))
          MINUTES_COUNT=$(find governance/board-minutes/ -name "*.md" -newer "$(date -d "$CURRENT_YEAR-01-01" +%Y-%m-%d)" 2>/dev/null | wc -l)
          echo "minutes_this_year=$MINUTES_COUNT" >> $GITHUB_OUTPUT
          if [ "$MINUTES_COUNT" -lt "$CURRENT_QUARTER" ]; then
            echo "status=WARN" >> $GITHUB_OUTPUT
          else
            echo "status=PASS" >> $GITHUB_OUTPUT
          fi

      - name: Check worship service logs
        id: worship
        run: |
          CURRENT_MONTH=$(date +%Y-%m)
          SERVICES=$(find programs/worship-services/ -name "$CURRENT_MONTH*.md" 2>/dev/null | wc -l)
          echo "services_this_month=$SERVICES" >> $GITHUB_OUTPUT
          WEEKS_IN_MONTH=$(( ($(date +%d) + 6) / 7 ))
          if [ "$SERVICES" -lt "$WEEKS_IN_MONTH" ]; then
            echo "status=WARN" >> $GITHUB_OUTPUT
          else
            echo "status=PASS" >> $GITHUB_OUTPUT
          fi

      - name: Check financial records
        id: financials
        run: |
          LAST_MONTH=$(date -d "last month" +%Y-%m)
          if [ -f "financials/bank-reconciliations/$LAST_MONTH-reconciliation.md" ]; then
            echo "status=PASS" >> $GITHUB_OUTPUT
          else
            echo "status=WARN" >> $GITHUB_OUTPUT
          fi

      - name: Calculate 14-point test score
        id: score
        run: |
          SCORE=0
          # 1. Distinct religious history — check statement of faith
          [ -f "formation/statement-of-faith.md" ] && SCORE=$((SCORE + 1))
          # 2. Recognized creed — doctrinal statement exists
          [ -f "formation/statement-of-faith.md" ] && SCORE=$((SCORE + 1))
          # 3. Definite ecclesiastical government — bylaws exist
          [ -f "formation/church-bylaws.md" ] && SCORE=$((SCORE + 1))
          # 4. Formal code of doctrine — formation docs
          [ -f "formation/articles-of-incorporation.md" ] && SCORE=$((SCORE + 1))
          # 5. Distinct membership — membership rolls exist
          [ -d "membership/rolls" ] && [ "$(ls -A membership/rolls/ 2>/dev/null)" ] && SCORE=$((SCORE + 1))
          # 6. Ordained ministers — ordination records
          [ -d "membership/ordinations" ] && [ "$(ls -A membership/ordinations/ 2>/dev/null)" ] && SCORE=$((SCORE + 1))
          # 7. Regular worship services — service logs
          [ -d "programs/worship-services" ] && [ "$(ls -A programs/worship-services/ 2>/dev/null)" ] && SCORE=$((SCORE + 1))
          # 8. Sunday schools / education
          [ -d "programs/education" ] && [ "$(ls -A programs/education/ 2>/dev/null)" ] && SCORE=$((SCORE + 1))
          # 9. Schools for ministers — ordination curriculum link
          [ -f "membership/ordinations/curriculum-link.md" ] && SCORE=$((SCORE + 1))
          # 10. Own place of worship
          [ -f "formation/place-of-worship.md" ] && SCORE=$((SCORE + 1))
          # 11. Regular congregation
          SERVICES_TOTAL=$(find programs/worship-services/ -name "*.md" 2>/dev/null | wc -l)
          [ "$SERVICES_TOTAL" -gt 4 ] && SCORE=$((SCORE + 1))
          # 12. Religious services available to public
          [ -f "programs/public-services.md" ] && SCORE=$((SCORE + 1))
          # 13. Organization of and conduct of activities
          [ -f "formation/organizational-meeting-minutes.md" ] && SCORE=$((SCORE + 1))
          # 14. Established place of worship
          [ -f "formation/place-of-worship.md" ] && SCORE=$((SCORE + 1))

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "total=14" >> $GITHUB_OUTPUT

      - name: Generate compliance report
        run: |
          cat > compliance-report.md << 'REPORT'
          # Compliance Report — $(date +%Y-%m-%d)

          ## Summary

          | Check | Status |
          |-------|--------|
          | Formation Documents | ${{ steps.formation.outputs.status }} |
          | Governance Records | ${{ steps.governance.outputs.status }} |
          | Worship Services | ${{ steps.worship.outputs.status }} |
          | Financial Records | ${{ steps.financials.outputs.status }} |
          | **14-Point Test Score** | **${{ steps.score.outputs.score }} / ${{ steps.score.outputs.total }}** |

          ## Details

          - Board minutes this year: ${{ steps.governance.outputs.minutes_this_year }}
          - Worship services this month: ${{ steps.worship.outputs.services_this_month }}

          ---
          *Generated by Living Light OS Compliance Engine*
          REPORT
          echo "Report generated"

      - name: Create issue if compliance failing
        if: steps.formation.outputs.status == 'FAIL' || steps.score.outputs.score < 10
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.score.outputs.score }}';
            const formation = '${{ steps.formation.outputs.status }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Compliance Alert] Action required — Score: ${score}/14`,
              body: `## Compliance Alert\n\nYour church's compliance score is **${score}/14**. The recommended minimum is 10/14.\n\n### Issues Found\n- Formation documents: ${formation}\n\n### What To Do\nVisit your compliance dashboard at os.livinglightchurch.org for specific guidance.\n\nIf you need help, contact compliance@livinglightchurch.org.\n\n---\n*This issue was created automatically by Living Light OS.*`,
              labels: ['compliance', 'action-required']
            });

      - name: Notify Living Light HQ
        if: steps.score.outputs.score < 10
        run: |
          echo "::warning::Compliance score below threshold. HQ notification would be sent here."
          # In production: POST to Living Light platform API
          # curl -X POST https://os.livinglightchurch.org/api/compliance/alert \
          #   -H "Authorization: Bearer ${{ secrets.LIVING_LIGHT_API_KEY }}" \
          #   -d '{"repo": "${{ github.repository }}", "score": "${{ steps.score.outputs.score }}"}'
